#!/bin/sh
#
# Copyright 2012 Todd Brandt <tebrandt@frontier.com>
#
# This program is free software; you may redistribute it and/or modify it
# under the GNU GPL license.
#
#    Webcam manager utility for launching and monitoring mjpg instances
#    Copyright (C) 2012 Todd Brandt <tebrandt@frontier.com>
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

if [ -e "/var/lock/webcam" ]; then
	echo "Another webcam-manager is already running"
	exit
fi
touch "/var/lock/webcam"

DAEMON="/usr/bin/mjpg_streamer"
VIDARGS="-r 1280x720 -f 24"

while [ 1 ]; do
	DEVICES=`ls -1 /dev/video?`
	PIDS=""
	for d in $DEVICES;
	do
		NUM=`echo $d | sed "s/[a-z,/]//g"`
		PORT="809$NUM"
		INPUTARG="/usr/lib/input_uvc.so -d $d $VIDARGS"
		OUTPUTARG="/usr/lib/output_http.so -p $PORT"
		LOG="/var/log/mjpg_streamer$NUM.log"
		PID=`ps -C mjpg_streamer --no-headers -o pid,args | grep $d | head -1 | awk '{print $1}'`
		if [ -z "$PID" ]; then
			$DAEMON -i "$INPUTARG" -o "$OUTPUTARG" > $LOG 2>&1 &
			PID=$!
			echo "New mjpg_streamer for $d with PID $PID"
		fi
		PIDS="$PID $PIDS"
	done

	while [ 1 ]; do
		EVERYBODYONLINE=1
		for p in $PIDS;
		do
			CHECK=`ps --pid $p --no-headers | awk '{print $4}'`
			if [ "$CHECK" != "mjpg_streamer" ]; then
				echo "Dead mjpg_streamer with PID $PID"
				EVERYBODYONLINE=0
			fi
		done
		if [ $EVERYBODYONLINE -ne 1 ]; then
			break
		fi
		sleep 5
	done
done
